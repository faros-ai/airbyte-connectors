# O365CAL-015: Extended Event Metadata & Field Mapping Enhancement

## Overview
Enhance event metadata extraction and field mapping to achieve complete feature parity with Google Calendar connector, including advanced attendee details, recurrence patterns, attachments, and Office 365-specific features.

## Status
**Phase**: Not Started  
**Priority**: Medium (Important for data completeness)  
**Effort**: 2-3 days  
**Dependencies**: O365CAL-011b (Basic Events Converter)  

## Problem Statement
Current event conversion captures basic fields but missing:
- **Attendee response details**: Response time, optional status, attendee type
- **Recurrence information**: Pattern details, exception handling, series metadata
- **Meeting metadata**: Online meeting details, Teams integration, recording links
- **Attachment information**: File attachments, inline attachments, sharing permissions
- **Extended properties**: Custom fields, categories, importance levels
- **Office 365 specific features**: Booking details, room resources, equipment

Google Calendar converter provides comprehensive field mapping that we should match.

## Tests That Must Pass

### 1. Enhanced Attendee Metadata Tests (RED → GREEN → REFACTOR)
```typescript
describe('EnhancedAttendeeMetadata', () => {
  test('extracts attendee response timestamps');
  test('captures attendee type (required, optional, resource)');
  test('includes attendee role (organizer, attendee, delegate)');
  test('handles external attendees vs internal users');
  test('processes attendee groups and distribution lists');
  test('maps response status with confidence levels');
  test('preserves attendee-specific custom properties');
});
```

### 2. Recurrence Pattern Processing Tests
```typescript
describe('RecurrencePatternProcessing', () => {
  test('extracts daily recurrence with interval and end date');
  test('processes weekly recurrence with specific days');
  test('handles monthly recurrence by date vs by day-of-week');
  test('captures yearly recurrence with month and day variations');
  test('processes complex patterns (e.g., 2nd Tuesday of month)');
  test('handles recurrence exceptions and modified instances');
  test('links series master with individual occurrences');
});
```

### 3. Meeting Technology Integration Tests
```typescript
describe('MeetingTechnologyIntegration', () => {
  test('extracts Teams meeting URLs and conference IDs');
  test('captures Zoom integration details when present');
  test('processes dial-in information and conference bridges');
  test('handles hybrid meeting details (physical + virtual)');
  test('extracts recording information and sharing permissions');
  test('maps meeting lobby settings and access controls');
});
```

### 4. Attachment Processing Tests
```typescript
describe('AttachmentProcessing', () => {
  test('inventories file attachments with metadata');
  test('captures attachment permissions and sharing scope');
  test('processes inline attachments and embedded content');
  test('handles OneDrive/SharePoint linked attachments');
  test('extracts attachment preview information');
  test('maps attachment virus scan status');
});
```

### 5. Extended Properties & Categories Tests
```typescript
describe('ExtendedPropertiesAndCategories', () => {
  test('captures Outlook categories and color coding');
  test('extracts importance levels (low, normal, high)');
  test('processes sensitivity levels (normal, personal, private, confidential)');
  test('handles custom extended properties');
  test('maps Office 365 specific flags and markers');
  test('preserves booking and scheduling metadata');
});
```

### 6. Office 365 Specific Features Tests
```typescript
describe('Office365SpecificFeatures', () => {
  test('extracts room and resource booking details');
  test('processes equipment reservations');
  test('captures workspace booking information');
  test('handles catering and service requests');
  test('maps approval workflow status');
  test('processes delegate and proxy information');
});
```

## Implementation Tasks

### Phase 1: Enhanced Data Models (TDD Red)
- [ ] **Write failing tests** for extended metadata extraction
- [ ] **Expand Office365Event interface** with additional fields:
  ```typescript
  interface Office365Event {
    // Enhanced attendee information
    attendees?: Office365EnhancedAttendee[];
    // Recurrence details
    recurrence?: Office365RecurrencePattern;
    // Meeting technology
    onlineMeeting?: Office365OnlineMeeting;
    // Attachments
    attachments?: Office365Attachment[];
    // Extended properties
    categories?: string[];
    importance?: 'low' | 'normal' | 'high';
    sensitivity?: 'normal' | 'personal' | 'private' | 'confidential';
    // Office 365 specific
    bookingInformation?: Office365BookingInfo;
    isOrganizer?: boolean;
    responseRequested?: boolean;
    showAs?: 'free' | 'tentative' | 'busy' | 'oof' | 'workingElsewhere';
  }
  ```
- [ ] **Define supporting interfaces** for complex types
- [ ] **Create test fixtures** with rich Office 365 API responses

### Phase 2: Enhanced Attendee Processing (TDD Green)
- [ ] **Implement Office365EnhancedAttendee interface**:
  ```typescript
  interface Office365EnhancedAttendee extends Office365Attendee {
    type: 'required' | 'optional' | 'resource';
    role?: 'organizer' | 'attendee' | 'delegate';
    responseTime?: string;
    proposedNewTime?: Office365DateTime;
    attendeeType?: 'person' | 'group' | 'resource' | 'room';
    emailAddress?: {
      address: string;
      name: string;
      routingType?: string;
    };
  }
  ```
- [ ] **Update attendee processing logic**
  - Enhanced response status mapping
  - Attendee type classification
  - External vs internal user detection
- [ ] **Extend cal_EventGuestAssociation model**
  - Additional attendee metadata fields
  - Response confidence and timing
  - Attendee role and type information

### Phase 3: Recurrence Pattern Enhancement (TDD Green)
- [ ] **Implement recurrence pattern extraction**:
  ```typescript
  interface Office365RecurrencePattern {
    type: 'daily' | 'weekly' | 'monthly' | 'yearly' | 'relativeMonthly' | 'relativeYearly';
    interval: number;
    daysOfWeek?: string[];
    dayOfMonth?: number;
    monthOfYear?: number;
    index?: 'first' | 'second' | 'third' | 'fourth' | 'last';
    firstDayOfWeek?: string;
  }
  ```
- [ ] **Add recurrence range processing**
  - Start/end date handling
  - Occurrence count limits
  - Exception date processing
- [ ] **Create recurrence-aware event models**
  - Series master vs occurrence distinction
  - Exception handling for modified instances
  - Recurrence state tracking

### Phase 4: Meeting Technology Integration (TDD Green)
- [ ] **Enhance online meeting processing**:
  ```typescript
  interface Office365OnlineMeeting {
    joinUrl?: string;
    conferenceId?: string;
    dialinUrl?: string;
    tollNumber?: string;
    tollFreeNumber?: string;
    accessCode?: string;
    quickDial?: string;
    platform?: 'teams' | 'skype' | 'zoom' | 'webex' | 'other';
    lobbyBypassSettings?: {
      scope: 'everyone' | 'organization' | 'organizer';
      isDialinBypassEnabled: boolean;
    };
  }
  ```
- [ ] **Update conference URL extraction**
  - Multi-platform detection (Teams, Zoom, WebEx)
  - Dial-in information extraction
  - Meeting lobby and security settings
- [ ] **Add meeting recording metadata**
  - Recording availability flags
  - Recording sharing permissions
  - Transcript availability

### Phase 5: Attachment & Content Processing (TDD Green)
- [ ] **Implement attachment metadata extraction**:
  ```typescript
  interface Office365Attachment {
    id: string;
    name: string;
    contentType: string;
    size?: number;
    isInline: boolean;
    contentId?: string;
    contentLocation?: string;
    downloadUrl?: string;
    sharingPermissions?: 'view' | 'edit' | 'owner';
    virusScanResult?: 'clean' | 'malware' | 'unknown';
  }
  ```
- [ ] **Add attachment processing pipeline**
  - File attachment enumeration
  - Inline content extraction
  - SharePoint/OneDrive link resolution
- [ ] **Security and compliance**
  - Attachment scanning status
  - DLP policy compliance
  - Sharing permission validation

### Phase 6: Extended Properties & Office 365 Features (TDD Green)
- [ ] **Implement extended property extraction**
  - Outlook categories and colors
  - Importance and sensitivity levels
  - Custom property processing
- [ ] **Add Office 365 specific features**:
  ```typescript
  interface Office365BookingInfo {
    rooms?: Office365Room[];
    equipment?: Office365Equipment[];
    catering?: Office365CateringRequest[];
    approvalStatus?: 'pending' | 'approved' | 'rejected';
    bookingReference?: string;
  }
  ```
- [ ] **Resource and room handling**
  - Room booking metadata
  - Equipment reservation details
  - Catering and service requests
- [ ] **Delegate and proxy support**
  - Acting-on-behalf information
  - Delegate permission levels
  - Proxy access tracking

### Phase 7: Field Mapping Enhancement (TDD Refactor)
- [ ] **Update Faros model mapping**
  - Extend cal_Event with new fields
  - Add Office 365-specific model extensions
  - Maintain backward compatibility
- [ ] **Optimize data extraction**
  - Selective field expansion based on configuration
  - Performance optimization for large events
  - Memory usage optimization for attachments
- [ ] **Add data quality controls**
  - Field validation and sanitization
  - Data completeness scoring
  - Error handling for malformed data

## Microsoft Graph API Integration

### Enhanced API Calls
- **Events with full expansion**: `GET /me/events?$expand=attachments,instances`
- **Recurrence details**: Include `$expand=instances` for series events
- **Online meeting info**: Use `onlineMeeting` expansion
- **Extended properties**: Custom property retrieval

### Additional Permissions Required
- `Calendars.ReadWrite` - For enhanced event details
- `Files.Read` - For attachment metadata
- `OnlineMeetings.Read` - For Teams meeting details
- `Directory.Read.All` - For attendee directory information

## Success Criteria
- [ ] All tests pass with 95%+ coverage
- [ ] Complete attendee metadata extraction (type, role, response timing)
- [ ] Full recurrence pattern support matching Google Calendar
- [ ] Comprehensive online meeting integration (Teams, Zoom, etc.)
- [ ] Attachment metadata extraction and security validation
- [ ] Office 365-specific features properly mapped to Faros models
- [ ] Performance maintained with enhanced data extraction
- [ ] Feature completeness parity with Google Calendar converter

## Risk Mitigation
- **API Response Size**: Implement selective field expansion based on configuration
- **Performance Impact**: Optimize attachment processing for large attachments
- **Data Privacy**: Ensure sensitive metadata handling follows compliance requirements
- **Complex Recurrence**: Comprehensive testing with edge case recurrence patterns

## Definition of Done
- [ ] All automated tests passing
- [ ] Manual testing with complex Office 365 events
- [ ] Performance benchmarks with enhanced metadata extraction
- [ ] Data mapping documentation updated
- [ ] Privacy and security review completed
- [ ] Feature parity assessment completed vs Google Calendar