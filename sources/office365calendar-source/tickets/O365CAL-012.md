# O365CAL-012: Multi-Calendar Support

## Overview
Implement comprehensive multi-calendar support to match Google Calendar connector functionality. Currently only syncs the default calendar; need to discover and sync all accessible calendars per user.

## Status
**Phase**: Not Started  
**Priority**: High (Critical for feature parity)  
**Effort**: 3-4 days  
**Dependencies**: None  

## Problem Statement
The current implementation only syncs events from the user's default calendar, missing events from:
- Shared calendars
- Group calendars  
- Resource calendars
- Secondary personal calendars

Google Calendar connector syncs all accessible calendars and provides filtering options.

## Tests That Must Pass

### 1. Calendars Stream Tests (RED → GREEN → REFACTOR)
```typescript
describe('CalendarsStream', () => {
  test('discovers all accessible calendars for authenticated user');
  test('handles pagination when user has 100+ calendars');
  test('respects calendar_ids filter configuration');
  test('includes calendar metadata: name, description, timezone, permissions');
  test('handles calendar access permission errors gracefully');
  test('excludes inaccessible calendars without failing sync');
  test('maps Office 365 calendar types to standard categories');
});
```

### 2. Multi-Calendar Events Tests  
```typescript
describe('EventsStream with Multi-Calendar', () => {
  test('fetches events from all discovered calendars');
  test('applies cutoff_days filter per calendar independently');
  test('handles calendar-specific incremental sync state');
  test('includes calendarId in event records for traceability');
  test('continues sync when individual calendar fails');
  test('respects events_max_results across all calendars');
  test('handles mixed permissions (read-only vs read-write calendars)');
});
```

### 3. Configuration Tests
```typescript
describe('Multi-Calendar Configuration', () => {
  test('calendar_ids filter includes only specified calendars');
  test('calendar_ids supports both IDs and display names');
  test('empty calendar_ids includes all accessible calendars');
  test('invalid calendar_ids are logged and skipped');
  test('calendar discovery respects user_principals configuration');
});
```

### 4. Integration Tests
```typescript
describe('Multi-Calendar Integration', () => {
  test('full sync with 3 calendars produces events from all');
  test('incremental sync maintains separate state per calendar');
  test('calendar deletion during sync handled gracefully');
  test('new calendar added mid-sync is discovered on next run');
});
```

## Implementation Tasks

### Phase 1: Calendars Discovery (TDD Red)
- [ ] **Write failing tests** for calendar discovery functionality
- [ ] **Create CalendarsDiscoveryService** test specifications
- [ ] **Define calendar metadata interfaces** in models.ts
- [ ] **Write failing integration tests** for multi-calendar event sync

### Phase 2: Calendars Stream Implementation (TDD Green)
- [ ] **Implement CalendarsDiscoveryService**
  - Graph API `/me/calendars` endpoint integration
  - Pagination handling with `@odata.nextLink`
  - Permission validation per calendar
- [ ] **Update CalendarsStream** 
  - Yield all discovered calendars
  - Apply calendar_ids filtering
  - Handle access permission errors
- [ ] **Add calendar metadata processing**
  - Map Office 365 fields to Faros schema
  - Include calendar ownership and permission details

### Phase 3: Multi-Calendar Events (TDD Green)
- [ ] **Refactor EventsStream**
  - Iterator pattern over discovered calendars
  - Per-calendar event fetching with context
  - Calendar-specific error handling
- [ ] **Update incremental sync logic**
  - Separate sync state per calendar
  - Calendar-aware delta token management
  - Graceful degradation when calendar becomes inaccessible
- [ ] **Add calendar context to events**
  - Include calendarId in event records
  - Calendar-specific metadata inheritance

### Phase 4: Configuration Enhancement (TDD Green)
- [ ] **Extend spec.json** with new configuration options:
  ```json
  {
    "calendar_ids": {
      "type": "array",
      "items": {"type": "string"},
      "description": "List of calendar IDs or names to sync. Empty = all accessible calendars"
    },
    "user_principals": {
      "type": "array", 
      "items": {"type": "string"},
      "description": "List of user principals for multi-user scenarios"
    }
  }
  ```
- [ ] **Update configuration validation**
- [ ] **Add calendar filtering logic**

### Phase 5: Testing & Validation (TDD Refactor)
- [ ] **Create comprehensive test fixtures**
  - Multi-calendar API response mocks
  - Various calendar permission scenarios
  - Edge cases (empty calendars, deleted calendars)
- [ ] **Performance testing**
  - 50+ calendars with 1000+ events each
  - Memory usage during large syncs
  - API rate limiting compliance
- [ ] **Error scenario testing**
  - Network failures during calendar discovery
  - Permission changes mid-sync
  - Malformed calendar responses

## API Integration Details

### Microsoft Graph Endpoints
- **Calendar Discovery**: `GET /me/calendars`
- **Shared Calendars**: `GET /me/calendarGroups/{id}/calendars`  
- **Events per Calendar**: `GET /me/calendars/{id}/events`
- **Delta Queries**: `GET /me/calendars/{id}/events/delta`

### Permission Requirements
- `Calendars.Read` - Basic calendar access
- `Calendars.Read.Shared` - Shared calendar access
- `Group.Read.All` - Group calendar discovery

## Success Criteria
- [ ] All tests pass with 95%+ coverage
- [ ] Syncs events from all accessible calendars (not just default)
- [ ] Configuration allows calendar filtering
- [ ] Performance acceptable with 50+ calendars
- [ ] Graceful error handling for permission issues
- [ ] Feature parity with Google Calendar multi-calendar support

## Risk Mitigation
- **API Rate Limits**: Implement exponential backoff and respect Graph API throttling
- **Memory Usage**: Stream processing for large calendar sets  
- **Permission Complexity**: Comprehensive error handling and user feedback
- **Backward Compatibility**: Ensure existing single-calendar configs continue working

## Definition of Done
- [ ] All automated tests passing
- [ ] Manual testing with multi-calendar Office 365 account
- [ ] Performance benchmarks meet requirements  
- [ ] Documentation updated with new configuration options
- [ ] Integration tests demonstrate feature parity with Google Calendar