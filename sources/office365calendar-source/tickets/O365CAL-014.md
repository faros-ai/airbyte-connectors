# O365CAL-014: Enhanced Configuration Options & Filtering

## Overview
Implement comprehensive configuration options to match Google Calendar connector flexibility, including advanced filtering, user selection, event type controls, and performance tuning parameters.

## Status
**Phase**: Not Started  
**Priority**: Medium (Important for enterprise adoption)  
**Effort**: 2-3 days  
**Dependencies**: O365CAL-012 (Multi-Calendar Support)  

## Problem Statement
Current configuration is basic compared to Google Calendar connector:
- Limited filtering options (only `calendar_ids`, `cutoff_days`)
- No user-level controls for multi-tenant scenarios
- No event type filtering (meetings vs appointments vs all-day events)
- Missing performance tuning options
- No advanced incremental sync controls

Enterprise users need granular control over data synchronization scope and behavior.

## Tests That Must Pass

### 1. User Selection Configuration Tests (RED → GREEN → REFACTOR)
```typescript
describe('UserSelectionConfig', () => {
  test('user_principals=[] syncs all accessible users');
  test('user_principals with specific emails limits sync scope');
  test('invalid user principals are logged and skipped');
  test('user principal validation against tenant permissions');
  test('handles user not found gracefully');
  test('supports UPN and email address formats');
});
```

### 2. Event Type Filtering Tests
```typescript
describe('EventTypeFiltering', () => {
  test('event_types=["meeting"] includes only meetings with attendees');
  test('event_types=["appointment"] includes only single-person events');
  test('event_types=["all-day"] includes only all-day events');
  test('event_types=[] includes all event types');
  test('multiple event types combined with OR logic');
  test('unknown event types are logged and ignored');
});
```

### 3. Advanced Calendar Filtering Tests
```typescript
describe('AdvancedCalendarFiltering', () => {
  test('calendar_filter_mode="include" processes only specified calendars');
  test('calendar_filter_mode="exclude" skips specified calendars');
  test('calendar_name_patterns supports regex matching');
  test('calendar_owner_filter limits by calendar ownership');
  test('shared_calendars_only excludes personal calendars');
});
```

### 4. Performance & Behavior Configuration Tests
```typescript
describe('PerformanceConfiguration', () => {
  test('max_events_per_calendar respects limit per calendar');
  test('max_total_events caps overall sync volume');
  test('request_timeout_seconds configures API timeouts');
  test('max_concurrent_calendars limits parallel processing');
  test('retry_backoff_seconds configures error recovery timing');
});
```

### 5. Data Quality & Privacy Tests
```typescript
describe('DataQualityConfiguration', () => {
  test('include_private_events=false excludes private events');
  test('include_cancelled_events=false filters cancelled events');
  test('include_declined_events=false excludes declined attendee events');
  test('anonymize_attendees=true hashes attendee information');
  test('content_filtering removes sensitive keywords');
});
```

### 6. Integration & Validation Tests
```typescript
describe('ConfigurationIntegration', () => {
  test('complex configuration combinations work correctly');
  test('configuration validation catches invalid combinations');
  test('configuration changes preserve incremental sync state');
  test('default values provide sensible behavior');
  test('configuration schema evolution maintains backward compatibility');
});
```

## Implementation Tasks

### Phase 1: Configuration Schema Design (TDD Red)
- [ ] **Write failing tests** for all configuration options
- [ ] **Design comprehensive spec.json** with validation rules
- [ ] **Create configuration interfaces** in TypeScript
- [ ] **Define validation logic** for configuration combinations

### Phase 2: User Selection Implementation (TDD Green)
- [ ] **Extend spec.json** with user controls:
  ```json
  {
    "user_principals": {
      "type": "array",
      "items": {"type": "string"},
      "description": "List of user principal names (UPNs) to sync. Empty = all accessible users"
    },
    "include_shared_mailboxes": {
      "type": "boolean",
      "default": false,
      "description": "Include events from shared mailboxes"
    }
  }
  ```
- [ ] **Implement user discovery service**
  - Graph API `/users` endpoint integration for tenant-wide scenarios
  - User principal validation and normalization
  - Permission checking per user
- [ ] **Update calendar discovery** to respect user selection

### Phase 3: Event Type & Content Filtering (TDD Green)
- [ ] **Add event type configuration**:
  ```json
  {
    "event_types": {
      "type": "array",
      "items": {"enum": ["meeting", "appointment", "all-day", "recurring", "series"]},
      "description": "Types of events to include"
    },
    "include_private_events": {
      "type": "boolean", 
      "default": true,
      "description": "Include events marked as private"
    },
    "include_cancelled_events": {
      "type": "boolean",
      "default": true, 
      "description": "Include cancelled events"
    },
    "include_declined_events": {
      "type": "boolean",
      "default": true,
      "description": "Include events where user declined attendance"
    }
  }
  ```
- [ ] **Implement event filtering pipeline**
  ```typescript
  class EventFilterPipeline {
    filterByType(events: Event[], types: EventType[]): Event[]
    filterByPrivacy(events: Event[], includePrivate: boolean): Event[]
    filterByStatus(events: Event[], config: StatusFilterConfig): Event[]
    filterByAttendance(events: Event[], includeDeclined: boolean): Event[]
  }
  ```
- [ ] **Add content anonymization**
  - Attendee email hashing option
  - Sensitive keyword filtering
  - PII redaction capabilities

### Phase 4: Advanced Calendar Filtering (TDD Green)
- [ ] **Calendar filtering configuration**:
  ```json
  {
    "calendar_filter_mode": {
      "enum": ["include", "exclude"],
      "default": "include",
      "description": "Whether calendar_ids list is inclusive or exclusive"
    },
    "calendar_name_patterns": {
      "type": "array",
      "items": {"type": "string"},
      "description": "Regex patterns for calendar name matching"
    },
    "calendar_owner_filter": {
      "enum": ["all", "owned", "shared"],
      "default": "all",
      "description": "Filter calendars by ownership type"
    }
  }
  ```
- [ ] **Implement advanced calendar filtering**
  - Regex pattern matching for calendar names
  - Ownership-based filtering logic
  - Include/exclude mode switching

### Phase 5: Performance & Reliability Configuration (TDD Green)
- [ ] **Performance tuning options**:
  ```json
  {
    "max_events_per_calendar": {
      "type": "integer",
      "default": 10000,
      "description": "Maximum events to fetch per calendar"
    },
    "max_total_events": {
      "type": "integer", 
      "default": 100000,
      "description": "Maximum total events across all calendars"
    },
    "max_concurrent_calendars": {
      "type": "integer",
      "default": 5,
      "description": "Number of calendars to process concurrently"
    },
    "request_timeout_seconds": {
      "type": "integer",
      "default": 30,
      "description": "Timeout for individual API requests"
    },
    "retry_backoff_seconds": {
      "type": "integer",
      "default": 2,
      "description": "Base delay for exponential backoff retries"
    }
  }
  ```
- [ ] **Implement performance controls**
  - Concurrent processing limits
  - Request timeout enforcement
  - Circuit breaker patterns for reliability
- [ ] **Add monitoring & telemetry**
  - Performance metrics collection
  - Configuration impact tracking
  - Usage pattern analytics

### Phase 6: Configuration Validation & Migration (TDD Green)
- [ ] **Comprehensive validation**
  ```typescript
  class ConfigurationValidator {
    validateUserPrincipals(config: Config): ValidationResult
    validateFilterCombinations(config: Config): ValidationResult
    validatePerformanceSettings(config: Config): ValidationResult
    validateBackwardCompatibility(config: Config): ValidationResult
  }
  ```
- [ ] **Configuration migration**
  - Handle legacy configuration formats
  - Provide sensible defaults for new options
  - Migration warnings and guidance
- [ ] **Runtime configuration monitoring**
  - Configuration change impact assessment
  - Performance regression detection

## Configuration Examples

### Enterprise Multi-User Setup
```json
{
  "client_id": "...",
  "client_secret": "...",
  "tenant_id": "...",
  "user_principals": ["user1@company.com", "user2@company.com"],
  "calendar_filter_mode": "exclude",
  "calendar_name_patterns": [".*test.*", ".*temp.*"],
  "event_types": ["meeting", "all-day"],
  "include_private_events": false,
  "max_concurrent_calendars": 10,
  "max_events_per_calendar": 5000
}
```

### Privacy-Focused Configuration
```json
{
  "include_private_events": false,
  "include_cancelled_events": false,
  "anonymize_attendees": true,
  "content_filtering": ["confidential", "private", "secret"],
  "calendar_owner_filter": "owned"
}
```

### Performance-Optimized Configuration
```json
{
  "max_total_events": 50000,
  "max_concurrent_calendars": 15,
  "request_timeout_seconds": 60,
  "retry_backoff_seconds": 1,
  "cutoff_days": 30
}
```

## Success Criteria
- [ ] All tests pass with 95%+ coverage
- [ ] Configuration options provide granular control over sync behavior
- [ ] Enterprise scenarios supported (multi-user, privacy, performance)
- [ ] Backward compatibility maintained for existing configurations
- [ ] Configuration validation prevents invalid combinations
- [ ] Performance tuning options demonstrably improve large-scale syncs
- [ ] Feature parity with Google Calendar configuration flexibility

## Risk Mitigation
- **Configuration Complexity**: Comprehensive documentation and examples
- **Performance Impact**: Benchmarking with various configuration combinations
- **Backward Compatibility**: Extensive migration testing
- **Validation Coverage**: Edge case testing for configuration combinations

## Definition of Done
- [ ] All automated tests passing
- [ ] Manual testing with various enterprise configuration scenarios
- [ ] Performance impact assessment for all new options
- [ ] Documentation with comprehensive configuration examples
- [ ] Migration guide for existing users
- [ ] Configuration validation handles all edge cases