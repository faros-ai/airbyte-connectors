# O365CAL-013: Deleted Events Support & Delta Sync Enhancement

## Overview
Implement comprehensive deleted events tracking using Microsoft Graph Delta queries to achieve reliable incremental synchronization with tombstone records, matching Google Calendar connector capabilities.

## Status
**Phase**: Not Started  
**Priority**: High (Critical for data integrity)  
**Effort**: 4-5 days  
**Dependencies**: O365CAL-012 (Multi-Calendar Support)  

## Problem Statement
Current incremental sync implementation:
- Only tracks new/updated events via `updated > cutoff_time`
- Cannot detect deleted events, leaving stale data in destination
- Uses simple time-based filtering instead of Graph API delta queries
- No support for `_ab_record_deleted` tombstone records

Google Calendar connector properly handles deletions through dedicated mechanisms.

## Tests That Must Pass

### 1. Delta Query Implementation Tests (RED → GREEN → REFACTOR)
```typescript
describe('DeltaQueryManager', () => {
  test('initializes delta query with empty state');
  test('processes delta response with nextLink pagination');
  test('handles deltaLink token persistence across sync runs');
  test('recovers gracefully when delta token expires');
  test('falls back to full refresh on invalid delta token');
  test('manages separate delta state per calendar');
  test('handles Graph API throttling during delta queries');
});
```

### 2. Deleted Events Detection Tests
```typescript
describe('DeletedEventsHandling', () => {
  test('detects events with @removed annotation');
  test('emits tombstone records with _ab_record_deleted=true');
  test('preserves event ID in deleted record for downstream processing');
  test('handles bulk deletion scenarios efficiently');
  test('processes mixed batch: created, updated, deleted events');
  test('validates deleted event record structure matches schema');
});
```

### 3. Incremental Sync State Tests
```typescript
describe('IncrementalSyncState', () => {
  test('persists deltaLink tokens per calendar in state');
  test('restores state correctly after sync interruption');
  test('handles state corruption with fallback to full refresh');
  test('manages state size with calendar count scaling');
  test('validates state schema evolution compatibility');
  test('cleans up orphaned state for deleted calendars');
});
```

### 4. Configuration & Feature Toggle Tests
```typescript
describe('DeletedEventsConfiguration', () => {
  test('include_deleted=true enables tombstone record emission');
  test('include_deleted=false skips deleted event processing');
  test('backward compatibility when config option missing');
  test('validates configuration combinations with other options');
});
```

### 5. Integration Tests
```typescript
describe('DeltaSyncIntegration', () => {
  test('full sync→incremental→delete→incremental flow produces correct tombstones');
  test('handles calendar deletion during incremental sync');
  test('processes 1000+ event deletes efficiently');
  test('maintains data consistency across multiple incremental runs');
  test('recovers from network failures during delta query');
});
```

## Implementation Tasks

### Phase 1: Delta Query Foundation (TDD Red)
- [ ] **Write failing tests** for delta query management
- [ ] **Design DeltaQueryManager interface** with state persistence
- [ ] **Define tombstone record schema** following Airbyte standards
- [ ] **Create delta token state models** for persistence

### Phase 2: Delta Query Implementation (TDD Green)
- [ ] **Implement DeltaQueryManager class**
  ```typescript
  class DeltaQueryManager {
    async initializeDelta(calendarId: string): Promise<DeltaQuery>
    async processDeltaResponse(response: GraphDeltaResponse): Promise<ProcessedEvents>
    async persistState(calendarId: string, deltaLink: string): Promise<void>
    async restoreState(calendarId: string): Promise<string | null>
  }
  ```
- [ ] **Graph API delta endpoint integration**
  - `/me/calendars/{id}/events/delta` for calendar-specific deltas
  - Handle `@odata.deltaLink` and `@odata.nextLink` properly
  - Implement proper HTTP headers and query parameters
- [ ] **Delta response parsing**
  - Detect `@removed` annotations for deleted events
  - Process mixed batches of created/updated/deleted
  - Extract minimal metadata for tombstone records

### Phase 3: Tombstone Record Generation (TDD Green)
- [ ] **Deleted event record factory**
  ```typescript
  interface DeletedEventRecord {
    id: string;
    calendarId?: string;
    '@removed': { reason: string };
    _ab_record_deleted: true;
    deletedAt: string;
  }
  ```
- [ ] **Update Events converter**
  - Check for `@removed` annotation in event data
  - Generate tombstone records with required fields
  - Maintain event ID for downstream correlation
- [ ] **Airbyte record emission**
  - Emit with `_ab_record_deleted: true` metadata
  - Include minimal identifying information
  - Follow Airbyte CDC specification

### Phase 4: State Management (TDD Green)
- [ ] **Incremental sync state enhancement**
  ```typescript
  interface DeltaSyncState {
    calendars: {
      [calendarId: string]: {
        deltaLink?: string;
        lastFullSync?: string;
        syncMode: 'delta' | 'full';
      }
    };
    globalSettings: {
      deleteSyncEnabled: boolean;
      stateVersion: string;
    };
  }
  ```
- [ ] **State persistence layer**
  - Serialize/deserialize delta state properly
  - Handle state migration for schema evolution
  - Implement state size management for many calendars
- [ ] **Recovery mechanisms**
  - Fallback to full refresh on delta token expiry
  - State corruption detection and recovery
  - Network failure recovery with retry logic

### Phase 5: Configuration Integration (TDD Green)
- [ ] **Extend spec.json configuration**
  ```json
  {
    "include_deleted": {
      "type": "boolean",
      "default": false,
      "description": "Emit tombstone records for deleted events"
    },
    "delta_sync_enabled": {
      "type": "boolean", 
      "default": true,
      "description": "Use Graph delta queries for incremental sync"
    }
  }
  ```
- [ ] **Configuration validation**
- [ ] **Feature flag integration** for gradual rollout

### Phase 6: Testing & Performance (TDD Refactor)
- [ ] **Comprehensive test fixtures**
  - Graph API delta response mocks
  - Various deletion scenarios (single, bulk, calendar deletion)
  - Error conditions (expired tokens, network failures)
- [ ] **Performance benchmarks**
  - Delta query processing with 10k+ events
  - State persistence overhead measurement
  - Memory usage with large delta responses
- [ ] **Reliability testing**
  - Extended incremental sync scenarios
  - State corruption and recovery validation
  - Network failure resilience testing

## Microsoft Graph API Details

### Delta Query Endpoints
- **Initial Delta**: `GET /me/calendars/{id}/events/delta`
- **Delta Continuation**: Use `@odata.nextLink` from previous response
- **Delta Checkpoint**: Use `@odata.deltaLink` for next incremental run

### Delta Response Structure
```json
{
  "value": [
    {
      "id": "event1",
      "subject": "Updated Event",
      "@odata.etag": "W/\"new-etag\""
    },
    {
      "id": "event2", 
      "@removed": {
        "reason": "deleted"
      }
    }
  ],
  "@odata.deltaLink": "https://graph.microsoft.com/v1.0/me/calendars/calendar1/events/delta?$deltatoken=abc123"
}
```

### Error Handling
- **410 Gone**: Delta token expired → Full refresh required
- **429 Too Many Requests**: Implement exponential backoff
- **401 Unauthorized**: Token refresh required

## Success Criteria
- [ ] All tests pass with 95%+ coverage
- [ ] Deleted events emit proper tombstone records with `_ab_record_deleted=true`
- [ ] Delta queries used for all incremental syncs when available
- [ ] State management handles 100+ calendars efficiently
- [ ] Graceful fallback to full refresh when delta queries fail
- [ ] Performance acceptable for large deletion batches (1000+ events)
- [ ] Feature parity with Google Calendar deletion tracking

## Risk Mitigation
- **Delta Token Expiry**: Robust fallback to full refresh with proper logging
- **State Size Growth**: Periodic state cleanup and compression
- **API Rate Limiting**: Respect Graph API throttling with exponential backoff
- **Memory Usage**: Stream processing for large delta responses
- **Data Consistency**: Comprehensive testing of edge cases and error scenarios

## Definition of Done
- [ ] All automated tests passing
- [ ] Manual testing with event deletion scenarios
- [ ] Performance benchmarks meet requirements
- [ ] State management proven reliable under stress
- [ ] Documentation updated with new configuration options
- [ ] Integration tests demonstrate tombstone record functionality